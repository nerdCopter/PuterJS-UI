<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gemini 2.5 Flash</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f8fa; margin: 0; padding: 0; }
    #container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 24px; }
    #messages { min-height: 200px; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 16px; }
    .msg { margin: 12px 0; }
    .msg.user { text-align: right; color: #2563eb; }
    .msg.ai { text-align: left; color: #111827; }
    .msg .bubble { display: inline-block; padding: 10px 14px; border-radius: 14px; margin-bottom: 2px; }
    .msg.user .bubble { background: #dbeafe; }
    .msg.ai .bubble { background: #f3f4f6; }
    #input-row { display: flex; gap: 8px; margin-top: 12px; }
    #user-input { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
    #send-btn, #attach-btn, #unload-btn { padding: 0 18px; border: none; border-radius: 8px; background: #2563eb; color: #fff; font-size: 1rem; cursor: pointer; }
    #attach-btn { background: #6b7280; }
    #unload-btn { background: #e11d48; }
    #send-btn:hover { background: #1d4ed8; }
    #attach-btn:hover { background: #374151; }
    #unload-btn:hover { background: #be123c; }
    #file-input { display: none; }
    #attached-file { font-size: 0.95em; color: #374151; margin-right: 8px; margin-top: 2px; }
    .markdown-body { font-size: 1em; }
    .markdown-body pre, .markdown-body code { background: #f6f8fa; border-radius: 5px; padding: 2px 6px; }
    .markdown-body pre { padding: 8px; }
    .markdown-body a { color: #2563eb; }
    #unload-btn { display: none; }
  </style>
</head>
<body>
  <div id="container">
    <h2>Gemini 2.5 Flash</h2>
    <div id="messages"></div>
    <div id="input-row">
      <span id="attached-file"></span>
      <input type="text" id="user-input" placeholder="Type your message or attach a file..." autocomplete="off" />
      <button id="attach-btn" title="Attach file">ðŸ“Ž</button>
      <input type="file" id="file-input" />
      <button id="unload-btn">Unload File</button>
      <button id="send-btn">Send</button>
    </div>
  </div>
  <script>
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const attachBtn = document.getElementById('attach-btn');
    const unloadBtn = document.getElementById('unload-btn');
    const fileInput = document.getElementById('file-input');
    const attachedFileSpan = document.getElementById('attached-file');

    let fileContentPrompt = null;
    let fileNamePrompt = null;
    let chatHistory = [];

    function renderMarkdown(md) {
      const div = document.createElement('div');
      div.className = 'markdown-body';
      div.innerHTML = marked.parse(md);
      return div;
    }

    function addMessage(text, sender = 'user') {
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg ${sender}`;
      let bubble = `<div class="bubble"></div>`;
      msgDiv.innerHTML = bubble;
      if (text) {
        msgDiv.querySelector('.bubble').appendChild(renderMarkdown(text));
      }
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateUnloadBtn() {
      if (fileContentPrompt || fileNamePrompt) {
        unloadBtn.style.display = "inline-block";
      } else {
        unloadBtn.style.display = "none";
      }
    }

    unloadBtn.onclick = () => {
      fileContentPrompt = null;
      fileNamePrompt = null;
      attachedFileSpan.textContent = '';
      updateUnloadBtn();
    };

    async function sendMessage() {
      let text = userInput.value.trim();

      if (fileContentPrompt) {
        addMessage(fileNamePrompt, 'user');
        text = fileContentPrompt;
      } else if (text) {
        addMessage(text, 'user');
      } else {
        return;
      }

      const msgs = [];
      for (const entry of chatHistory) {
        msgs.push({ role: entry.sender === 'user' ? 'user' : 'assistant', content: entry.text });
      }
      msgs.push({ role: 'user', content: text });

      const aiDiv = document.createElement('div');
      aiDiv.className = 'msg ai';
      aiDiv.innerHTML = `<div class="bubble" id="ai-bubble"><em>Thinking...</em></div>`;
      messagesDiv.appendChild(aiDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      try {
        const response = await puter.ai.chat(
          msgs,
          { model: 'google/gemini-2.5-flash-preview:thinking', stream: true }
        );
        let aiText = '';
        for await (const part of response) {
          if (part?.text) {
            aiText += part.text;
            document.getElementById('ai-bubble').innerHTML = '';
            document.getElementById('ai-bubble').appendChild(renderMarkdown(aiText));
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        }
        chatHistory.push({ sender: 'ai', text: aiText });
      } catch (e) {
        document.getElementById('ai-bubble').innerHTML = `<span style="color:red;">Error: ${e.message}</span>`;
      }

      chatHistory.push({ sender: 'user', text });
      userInput.value = '';
      fileContentPrompt = null;
      fileNamePrompt = null;
      attachedFileSpan.textContent = '';
      updateUnloadBtn();
    }

    sendBtn.onclick = sendMessage;
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    attachBtn.onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
      console.log("File input changed");
      const file = e.target.files[0];
      if (!file) {
        console.log("No file selected");
        return;
      }
      try {
        if (
          file.type.startsWith('text/') ||
          file.name.endsWith('.js') ||
          file.name.endsWith('.rs') ||
          file.name.endsWith('.txt')
        ) {
          const text = await file.text();
          fileContentPrompt = `Analyze ${file.name}. Confirm receipt and wait for my request.\n\n${text}`;
          fileNamePrompt = `(${file.name})`;
          attachedFileSpan.textContent = `Loaded: ${file.name}`;
          userInput.value = '';
          updateUnloadBtn();
        } else if (file.type.startsWith('image/')) {
          console.log("Uploading file...");
          const uploadedFiles = await puter.fs.upload(e.target.files);
          console.log("Upload response:", uploadedFiles);
          const uploaded = Array.isArray(uploadedFiles) ? uploadedFiles[0] : uploadedFiles;
          if (uploaded && uploaded.url) {
            console.log("Public URL:", uploaded.url);
          } else if (uploaded && uploaded.path) {
            console.log("No public URL. Only virtual path:", uploaded.path);
          } else {
            console.log("No file object returned from upload");
          }
          alert(
            "Image uploaded to: " +
              (uploaded.url || uploaded.path) +
              "\nYou need a public URL to send to Gemini."
          );
          attachedFileSpan.textContent = '';
          fileContentPrompt = null;
          fileNamePrompt = null;
          updateUnloadBtn();
        } else {
          alert("Unsupported file type for direct Gemini input.");
          attachedFileSpan.textContent = '';
          fileContentPrompt = null;
          fileNamePrompt = null;
          updateUnloadBtn();
        }
      } catch (err) {
        console.error("Upload error:", err);
        alert("File upload failed: " + err.message);
        attachedFileSpan.textContent = '';
        fileContentPrompt = null;
        fileNamePrompt = null;
        updateUnloadBtn();
      }
    };

    updateUnloadBtn();
  </script>
</body>
</html>
